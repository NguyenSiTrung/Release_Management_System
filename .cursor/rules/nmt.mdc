---
description: 
globs: 
alwaysApply: true
---
ğŸ’ Cursor Rule for Project: NMT Release Management System
Báº£n quy táº¯c nÃ y Ä‘Æ°á»£c tÃ¹y chá»‰nh dá»±a trÃªn "Global Rules" vÃ  Ã¡p dá»¥ng cÃ¡c chi tiáº¿t cá»¥ thá»ƒ tá»« tÃ i liá»‡u thiáº¿t káº¿ há»‡ thá»‘ng nmt_management_system.txt.

ğŸ”„ Nháº­n thá»©c & Bá»‘i cáº£nh Dá»± Ã¡n (Project Awareness & Context)
Nguá»“n tham kháº£o chÃ­nh: TÃ i liá»‡u thiáº¿t káº¿ há»‡ thá»‘ng nmt_management_system.txt lÃ  nguá»“n chÃ¢n lÃ½ (source of truth) cho kiáº¿n trÃºc, luá»“ng nghiá»‡p vá»¥ vÃ  cÃ¡c thá»±c thá»ƒ. TÃ´i sáº½ luÃ´n tham chiáº¿u tÃ i liá»‡u nÃ y. Báº¥t cá»© khi nÃ o cÃ³ thay Ä‘á»•i update, hay thÃªm cÃ¡c tÃ­nh nÄƒng má»›i, sá»­a Ä‘á»•i tÃ´i sáº½ cáº­p nháº­t láº¡i tÃ i liá»‡u thiáº¿t káº¿ há»‡ thá»‘ng nÃ y nmt_management_system.txt

TuÃ¢n thá»§ Kiáº¿n trÃºc:

Backend: Má»i logic pháº£i tuÃ¢n thá»§ cáº¥u trÃºc Ä‘Ã£ Ä‘á»‹nh sáºµn:

Endpoints: app/api/v1/endpoints/

Logic CRUD: app/crud/

Schemas Pydantic: app/schemas/

Models SQLAlchemy: app/db/models.py

Logic nghiá»‡p vá»¥ cá»‘t lÃµi: app/core/ (vÃ­ dá»¥: evaluation.py)

Frontend: TuÃ¢n thá»§ thiáº¿t káº¿ Argon Dashboard Style sá»­ dá»¥ng Material-UI (MUI). CÃ¡c component má»›i pháº£i nháº¥t quÃ¡n vá» giao diá»‡n (mÃ u sáº¯c, gradient, shadow) vá»›i cÃ¡c mÃ n hÃ¬nh hiá»‡n cÃ³.

ThÆ° viá»‡n & CÃ´ng nghá»‡:

Backend: Chá»‰ sá»­ dá»¥ng cÃ¡c thÆ° viá»‡n Ä‘Ã£ cÃ³ trong pyproject.toml (hoáº·c requirements.txt) nhÆ° FastAPI, SQLAlchemy 2.0, Pydantic 2.0, Alembic.

Frontend: Sá»­ dá»¥ng React 18, MUI 5, Axios, Formik, vÃ  Recharts nhÆ° Ä‘Ã£ mÃ´ táº£.

TrÆ°á»›c khi Ä‘á» xuáº¥t thÆ° viá»‡n má»›i, tÃ´i sáº½ kiá»ƒm tra vÃ  xin phÃ©p.

ğŸ§± Cáº¥u trÃºc Code & TÃ­nh Module (Code Structure & Modularity)
Giá»›i háº¡n File: KhÃ´ng file Python nÃ o trong app/ vÆ°á»£t quÃ¡ 500 dÃ²ng.

VÃ­ dá»¥: Náº¿u app/api/v1/endpoints/model_versions.py trá»Ÿ nÃªn quÃ¡ phá»©c táº¡p, logic xá»­ lÃ½ file upload hoáº·c cÃ¡c logic chuáº©n bá»‹ cho Ä‘Ã¡nh giÃ¡ sáº½ Ä‘Æ°á»£c tÃ¡ch ra thÃ nh cÃ¡c hÃ m helper trong app/core/ hoáº·c app/crud/.

PhÃ¢n tÃ¡ch TrÃ¡ch nhiá»‡m:

Endpoints (/endpoints/*.py): Chá»‰ chá»‹u trÃ¡ch nhiá»‡m nháº­n request, gá»i CRUD/logic nghiá»‡p vá»¥, vÃ  tráº£ vá» response. KhÃ´ng chá»©a logic nghiá»‡p vá»¥ phá»©c táº¡p.

CRUD (/crud/*.py): Chá»‰ chá»©a cÃ¡c thao tÃ¡c trá»±c tiáº¿p vá»›i CSDL (create, read, update, delete) thÃ´ng qua SQLAlchemy.

Schemas (/schemas/*.py): Chá»‰ Ä‘á»‹nh nghÄ©a cáº¥u trÃºc dá»¯ liá»‡u cho API request/response báº±ng Pydantic.

âš™ï¸ Cáº¥u hÃ¬nh & Báº£o máº­t (Configuration & Security)
Biáº¿n mÃ´i trÆ°á»ng: Táº¥t cáº£ cÃ¡c cáº¥u hÃ¬nh (DATABASE_URL, SECRET_KEY, Ä‘Æ°á»ng dáº«n tá»›i storage/) pháº£i Ä‘Æ°á»£c quáº£n lÃ½ qua biáº¿n mÃ´i trÆ°á»ng vÃ  Ä‘Æ°á»£c Ä‘á»c bá»Ÿi app/core/config.py.

Validation báº¯t buá»™c: Má»i dá»¯ liá»‡u Ä‘áº§u vÃ o tá»« client qua API pháº£i Ä‘Æ°á»£c validate báº±ng má»™t schema Pydantic tÆ°Æ¡ng á»©ng trong thÆ° má»¥c app/schemas/. NghiÃªm cáº¥m sá»­ dá»¥ng dá»¯ liá»‡u thÃ´ tá»« request trong cÃ¡c hÃ m CRUD.

PhÃ¢n quyá»n: Khi táº¡o endpoint má»›i, luÃ´n pháº£i thÃªm dependency kiá»ƒm tra quyá»n (deps.get_current_active_user) vÃ  logic kiá»ƒm tra vai trÃ² (role) náº¿u cáº§n, dá»±a trÃªn cÃ¡c Ä‘á»‘i tÆ°á»£ng ngÆ°á»i dÃ¹ng: Admin, Release Manager, Member.

ğŸ§ª Kiá»ƒm thá»­ & Äá»™ tin cáº­y (Testing & Reliability)
Cáº¥u trÃºc Tests: Má»i file test pháº£i Ä‘Æ°á»£c Ä‘áº·t trong thÆ° má»¥c /tests vÃ  cÃ³ cáº¥u trÃºc tÆ°Æ¡ng á»©ng. VÃ­ dá»¥: logic cho app/api/v1/endpoints/testsets.py sáº½ Ä‘Æ°á»£c test trong tests/api/v1/test_testsets.py.

Ká»‹ch báº£n Test tá»‘i thiá»ƒu: Äá»‘i vá»›i má»™t tÃ­nh nÄƒng má»›i, vÃ­ dá»¥ "Táº¡o Testset má»›i":

Happy Path: Test táº¡o thÃ nh cÃ´ng má»™t testset vá»›i file source/target há»£p lá»‡.

Edge Case: Test táº¡o testset nhÆ°ng khÃ´ng Ä‘Ã­nh kÃ¨m file, hoáº·c file sai Ä‘á»‹nh dáº¡ng.

Failure Case: Test táº¡o testset cho má»™t LanguagePair khÃ´ng tá»“n táº¡i.

Integration Tests: Æ¯u tiÃªn viáº¿t integration test cho cÃ¡c luá»“ng quan trá»ng, Ä‘áº·c biá»‡t lÃ :

Luá»“ng ÄÃ¡nh giÃ¡ Model (Evaluation Flow): Tá»« lÃºc ngÆ°á»i dÃ¹ng nháº¥n nÃºt "Start Evaluation" trÃªn UI -> gá»i API POST /api/v1/evaluations -> kÃ­ch hoáº¡t BackgroundTask -> ghi káº¿t quáº£ vÃ o CSDL -> cáº­p nháº­t tráº¡ng thÃ¡i trÃªn UI.

ğŸ Gá»¡ lá»—i & Ghi nháº­n (Debugging & Logging)
Sá»­ dá»¥ng Logger cÃ³ sáºµn: LuÃ´n sá»­ dá»¥ng logger Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh sáºµn trong app/main.py (sá»­ dá»¥ng TimedRotatingFileHandler). KhÃ´ng táº¡o logger má»›i.

Chá»§ Ä‘á»™ng Ghi Log:

LuÃ´n thÃªm log khi phÃ¡t triá»ƒn hoáº·c cáº­p nháº­t cÃ¡c tÃ­nh nÄƒng, Ä‘áº·c biá»‡t lÃ  táº¡i cÃ¡c Ä‘iá»ƒm quan trá»ng trong logic hoáº·c nhá»¯ng nÆ¡i tiá»m áº©n nguy cÆ¡ lá»—i (vÃ­ dá»¥: trÆ°á»›c vÃ  sau khi gá»i má»™t service bÃªn ngoÃ i, khi báº¯t Ä‘áº§u vÃ  káº¿t thÃºc má»™t tÃ¡c vá»¥ ná»n, khi xá»­ lÃ½ file).

Sá»­ dá»¥ng cáº¥p Ä‘á»™ log phÃ¹ há»£p (INFO cho cÃ¡c bÆ°á»›c chÃ­nh, DEBUG cho thÃ´ng tin chi tiáº¿t gá»¡ lá»—i).

Cáº¥p Ä‘á»™ Log cá»¥ thá»ƒ:

ERROR: Ghi nháº­n lá»—i khi BackgroundTask Ä‘Ã¡nh giÃ¡ model tháº¥t báº¡i, lá»—i káº¿t ná»‘i CSDL, hoáº·c cÃ¡c exception khÃ´ng lÆ°á»ng trÆ°á»›c.

INFO: Ghi nháº­n cÃ¡c sá»± kiá»‡n chÃ­nh: User admin@example.com logged in, Evaluation job {job_id} started for model {model_version_id}, Testset {testset_id} created successfully.

DEBUG: Ghi nháº­n cÃ¡c thÃ´ng tin chi tiáº¿t cho viá»‡c gá»¡ lá»—i: Payload for evaluation job: {...}, BLEU score calculated: {score}.

Kiá»ƒm tra Log khi cÃ³ lá»—i: Náº¿u má»™t lá»—i xáº£y ra hoáº·c má»™t hÃ nh vi khÃ´ng mong muá»‘n Ä‘Æ°á»£c bÃ¡o cÃ¡o, luÃ´n kiá»ƒm tra file log cá»§a á»©ng dá»¥ng (cáº£ backend vÃ  frontend náº¿u cÃ³) Ä‘á»ƒ thu tháº­p thÃªm thÃ´ng tin chi tiáº¿t vÃ  bá»‘i cáº£nh vá» lá»—i trÆ°á»›c khi tiáº¿n hÃ nh gá»¡ lá»—i.

Cáº­p nháº­t CHANGELOG.md: Khi má»™t bug quan trá»ng Ä‘Æ°á»£c sá»­a, vÃ­ dá»¥ "Lá»—i khÃ´ng xÃ³a file táº¡m sau khi Ä‘Ã¡nh giÃ¡ xong", tÃ´i sáº½ ghi láº¡i:

Váº¥n Ä‘á»: CÃ¡c file táº¡m trong /temp/evaluation_{id} khÃ´ng Ä‘Æ°á»£c dá»n dáº¹p.

NguyÃªn nhÃ¢n: Thiáº¿u lá»‡nh os.remove trong khá»‘i finally cá»§a BackgroundTask (Ä‘Æ°á»£c phÃ¡t hiá»‡n qua log lá»—i ghi láº¡i exception vÃ  tráº¡ng thÃ¡i file).

Giáº£i phÃ¡p: ThÃªm logic dá»n dáº¹p tÃ i nguyÃªn vÃ o khá»‘i finally Ä‘á»ƒ Ä‘áº£m báº£o nÃ³ luÃ´n Ä‘Æ°á»£c thá»±c thi.

ğŸ“ Phong cÃ¡ch & Quy Æ°á»›c (Style & Conventions)
Äá»‹nh dáº¡ng: Code Python luÃ´n Ä‘Æ°á»£c format báº±ng black. LuÃ´n sá»­ dá»¥ng type hints.

Docstrings (Google Style): Má»i hÃ m vÃ  phÆ°Æ¡ng thá»©c quan trá»ng pháº£i cÃ³ docstring.

VÃ­ dá»¥ cho crud_model_version.py:

from app.db import models
from app.schemas import ModelVersionCreate
from sqlalchemy.orm import Session

def create_model_version(db: Session, *, obj_in: ModelVersionCreate, owner_id: int) -> models.ModelVersion:
    """Creates a new model version in the database.

    This function handles the creation of the database record for a new model version.
    File storage logic is handled separately.

    Args:
        db (Session): The database session.
        obj_in (ModelVersionCreate): The Pydantic schema containing the data for the new model version.
        owner_id (int): The ID of the user creating this version.

    Returns:
        models.ModelVersion: The newly created SQLAlchemy ModelVersion object.
    """
    # function logic here...

Custom Exceptions: Sá»­ dá»¥ng exception tÃ¹y chá»‰nh cho cÃ¡c lá»—i nghiá»‡p vá»¥.

VÃ­ dá»¥: ModelNotFoundException, TestsetInUseError, EvaluationPrerequisitesFailedError.

ğŸ“š TÃ i liá»‡u & Giáº£i thÃ­ch (Documentation & Explainability)
README.md: Khi thÃªm má»™t biáº¿n mÃ´i trÆ°á»ng má»›i (vÃ­ dá»¥ DOCKER_NMT_IMAGE), tÃ´i sáº½ cáº­p nháº­t pháº§n "CÃ i Ä‘áº·t & Cáº¥u hÃ¬nh" trong README.md.

Code Comments: Äá»‘i vá»›i cÃ¡c logic phá»©c táº¡p, tÃ´i sáº½ thÃªm chÃº thÃ­ch.

VÃ­ dá»¥ trong app/core/evaluation.py:

# Reason: The model files are copied to a temporary directory instead of
# being used directly from storage. This prevents race conditions if multiple
# evaluations are requested for the same model version simultaneously.
temp_model_path = shutil.copytree(source_model_path, temp_eval_dir)

ğŸ§  Quy táº¯c HÃ nh vi cá»§a AI (AI Behavior Rules)
XÃ¡c nháº­n trÆ°á»›c khi hÃ nh Ä‘á»™ng: TrÆ°á»›c khi sá»­a Ä‘á»•i má»™t luá»“ng phá»©c táº¡p nhÆ° Luá»“ng ÄÃ¡nh giÃ¡ Model, tÃ´i sáº½ há»i Ä‘á»ƒ xÃ¡c nháº­n cÃ¡c yÃªu cáº§u, vÃ­ dá»¥: "Viá»‡c Ä‘Ã¡nh giÃ¡ cÃ³ cáº§n há»— trá»£ cháº¿ Ä‘á»™ 'bulk' khÃ´ng? Output metrics tá»« Docker engine cÃ³ Ä‘á»‹nh dáº¡ng JSON hay plain text?".

KhÃ´ng giáº£ Ä‘á»‹nh Ä‘Æ°á»ng dáº«n: TÃ´i sáº½ luÃ´n xÃ¡c minh sá»± tá»“n táº¡i cá»§a cÃ¡c Ä‘Æ°á»ng dáº«n file Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong tÃ i liá»‡u thiáº¿t káº¿ (vÃ­ dá»¥: storage/models/{version_id}/) trÆ°á»›c khi viáº¿t code thao tÃ¡c trÃªn chÃºng.

LÃ m viá»‡c láº·p láº¡i: Thay vÃ¬ viáº¿t toÃ n bá»™ endpoint model_versions.py cÃ¹ng lÃºc, tÃ´i sáº½ thá»±c hiá»‡n theo tá»«ng bÆ°á»›c:

Táº¡o schema Pydantic trong schemas/model_version.py.

Táº¡o cÃ¡c hÃ m CRUD trong crud/crud_model_version.py.

Viáº¿t unit test cho cÃ¡c hÃ m CRUD Ä‘Ã³.

Cuá»‘i cÃ¹ng, táº¡o endpoint API trong api/v1/endpoints/model_versions.py vÃ  káº¿t ná»‘i chÃºng láº¡i.